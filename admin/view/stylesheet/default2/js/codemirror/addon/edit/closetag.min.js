!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)}(function(e){function t(t){if(t.getOption("disableInput"))return e.Pass;for(var r=t.listSelections(),n=[],s=0;s<r.length;s++){if(!r[s].empty())return e.Pass;var c=r[s].head,u=t.getTokenAt(c),f=e.innerMode(t.getMode(),u.state),h=f.state;if("xml"!=f.mode.name||!h.tagName)return e.Pass;var d=t.getOption("autoCloseTags"),p="html"==f.mode.configuration,g="object"==typeof d&&d.dontCloseTags||p&&l,m="object"==typeof d&&d.indentTags||p&&a,v=h.tagName;u.end>c.ch&&(v=v.slice(0,v.length-u.end+c.ch));var y=v.toLowerCase();if(!v||"string"==u.type&&(u.end!=c.ch||!/[\"\']/.test(u.string.charAt(u.string.length-1))||1==u.string.length)||"tag"==u.type&&"closeTag"==h.type||u.string.indexOf("/")==u.string.length-1||g&&i(g,y)>-1||o(t,v,c,h,!0))return e.Pass;var b=m&&i(m,y)>-1;n[s]={indent:b,text:">"+(b?"\n\n":"")+"</"+v+">",newPos:b?e.Pos(c.line+1,0):e.Pos(c.line,c.ch+1)}}for(var s=r.length-1;s>=0;s--){var w=n[s];t.replaceRange(w.text,r[s].head,r[s].anchor,"+insert");var x=t.listSelections().slice(0);x[s]={head:w.newPos,anchor:w.newPos},t.setSelections(x),w.indent&&(t.indentLine(w.newPos.line,null,!0),t.indentLine(w.newPos.line+1,null,!0))}}function r(t,r){for(var n=t.listSelections(),i=[],l=r?"/":"</",a=0;a<n.length;a++){if(!n[a].empty())return e.Pass;var s=n[a].head,c=t.getTokenAt(s),u=e.innerMode(t.getMode(),c.state),f=u.state;if(r&&("string"==c.type||"<"!=c.string.charAt(0)||c.start!=s.ch-1))return e.Pass;var h;if("xml"!=u.mode.name)if("htmlmixed"==t.getMode().name&&"javascript"==u.mode.name)h=l+"script";else{if("htmlmixed"!=t.getMode().name||"css"!=u.mode.name)return e.Pass;h=l+"style"}else{if(!f.context||!f.context.tagName||o(t,f.context.tagName,s,f))return e.Pass;h=l+f.context.tagName}">"!=t.getLine(s.line).charAt(c.end)&&(h+=">"),i[a]=h}t.replaceSelections(i),n=t.listSelections();for(var a=0;a<n.length;a++)(a==n.length-1||n[a].head.line<n[a+1].head.line)&&t.indentLine(n[a].head.line)}function n(t){return t.getOption("disableInput")?e.Pass:r(t,!0)}function i(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0,n=e.length;n>r;++r)if(e[r]==t)return r;return-1}function o(t,r,n,i,o){if(!e.scanForClosingTag)return!1;var l=Math.min(t.lastLine()+1,n.line+500),a=e.scanForClosingTag(t,n,null,l);if(!a||a.tag!=r)return!1;for(var s=i.context,c=o?1:0;s&&s.tagName==r;s=s.prev)++c;n=a.to;for(var u=1;c>u;u++){var f=e.scanForClosingTag(t,n,null,l);if(!f||f.tag!=r)return!1;n=f.to}return!0}e.defineOption("autoCloseTags",!1,function(r,i,o){if(o!=e.Init&&o&&r.removeKeyMap("autoCloseTags"),i){var l={name:"autoCloseTags"};("object"!=typeof i||i.whenClosing)&&(l["'/'"]=function(e){return n(e)}),("object"!=typeof i||i.whenOpening)&&(l["'>'"]=function(e){return t(e)}),r.addKeyMap(l)}});var l=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],a=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];e.commands.closeTag=function(e){return r(e)}});